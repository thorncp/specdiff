#!/usr/bin/env ruby

if ARGV.empty?
  # TODO: does this terminology make sense? probably not
  puts "Usage: specdiff [base-tree] <tree>"
  exit 1
end

if ARGV.size > 2
  puts "Don't what you're doing"
  exit 1
end

base = ARGV.size == 2 ? ARGV.shift : "master"
tree = ARGV.shift

`git checkout #{base} > /dev/null 2>&1`

before = `SPEC_OPTS="--order defined --format documentation --no-color" bundle exec rake`

File.open("before.txt", "w") do |f|
  f.puts before
end

`git checkout #{tree} > /dev/null 2>&1`

after = `SPEC_OPTS="--order defined --format documentation --no-color" bundle exec rake`

File.open("after.txt", "w") do |f|
  f.puts after
end

`git checkout - > /dev/null 2>&1`

diff = `diff -U 3 before.txt after.txt`

File.open("#{tree}.diff", "w") do |f|
  f.puts diff
end

exec "cat #{tree}.diff"
